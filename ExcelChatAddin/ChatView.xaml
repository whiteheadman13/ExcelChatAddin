<UserControl x:Class="ExcelChatAddin.ChatView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             MinWidth="200"
             MinHeight="200">

    <Grid Margin="8">
            <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <!-- ヘッダ -->
            <RowDefinition Height="*"/>
            <!-- チャット履歴 -->
            <RowDefinition Height="Auto"/>
            <!-- マスキング操作（👁） -->
            <RowDefinition Height="40"/>
            <!-- マスキングプレビュー -->
            <RowDefinition Height="Auto"/>
            <!-- 入力＋送信 -->
        </Grid.RowDefinitions>

        <!-- ============================= -->
        <!-- ヘッダ -->
        <!-- ============================= -->
        <Grid Grid.Row="0" Margin="0,0,0,6">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*" />
                <ColumnDefinition Width="Auto" />
            </Grid.ColumnDefinitions>

            <TextBlock Grid.Column="0"
                       Text="指示（中央：チャット履歴 / 下：入力）"
                       FontWeight="Bold" />

            <StackPanel Grid.Column="1" Orientation="Horizontal" HorizontalAlignment="Right" VerticalAlignment="Center">
                <!-- removed: 表形式で表示 (use input-area checkbox instead) -->
                <Button Content="クリア履歴" Width="80" Height="24" Click="ClearHistory_Click" ToolTip="チャット履歴をクリア" Margin="0,0,6,0"/>
                <Button Content="再解析" Width="80" Height="24" Click="ReparseHistory_Click" ToolTip="履歴を再解析して表を検出表示" Margin="0,0,6,0"/>
                           </StackPanel>
        </Grid>

        <!-- ============================= -->
        <!-- チャット履歴（表示専用） -->
        <!-- ============================= -->
        <Border Grid.Row="1"
                Margin="0,0,0,6"
                Background="#FFF8F8F8"
                BorderBrush="#FFCCCCCC"
                BorderThickness="1"
                Padding="6">
            <ScrollViewer x:Name="ChatHistoryScroll"
                          VerticalScrollBarVisibility="Auto">
                <StackPanel x:Name="ChatHistoryPanel"/>
            </ScrollViewer>
        </Border>

        <!-- ============================= -->
        <!-- マスキング操作（入力欄の上：右寄せ） -->
        <!-- ============================= -->
        <StackPanel Grid.Row="2"
                    Orientation="Horizontal"
                    HorizontalAlignment="Right"
                    Margin="0,0,0,4">

            <Button Content="クリア入力" Width="80" Height="28" Click="ClearInput_Click" ToolTip="入力欄をクリア"/>
            <StackPanel Orientation="Vertical" HorizontalAlignment="Right" Margin="0,0,8,0">
                <CheckBox x:Name="chkRequestTable" Content="表形式で回答" Checked="ChkRequestTable_Checked" Unchecked="ChkRequestTable_Unchecked" Margin="0,0,0,4"/>
                <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">
                    <ComboBox x:Name="cmbModel" Width="140" SelectionChanged="CmbModel_SelectionChanged">
                        <ComboBoxItem Tag="gemini-2.5-flash">gemini-2.5-flash</ComboBoxItem>
                        <ComboBoxItem Tag="gemini-2.5-pro">gemini-2.5-pro</ComboBoxItem>
                        <ComboBoxItem Tag="gemini-3-flash">gemini-3-flash-preview</ComboBoxItem>
                        <ComboBoxItem Tag="gemini-3-pro">gemini-3-pro</ComboBoxItem>
                    </ComboBox>
                </StackPanel>
            </StackPanel>
 
            <Button Content="👁"
                    Width="36"
                    Height="28"
                    ToolTip="入力内容のマスキング確認"
                    Click="BtnMaskPreview_Click"/>
            <Button Content="送信プレビュー" Margin="6,0,0,0" Height="28" Click="BtnSendPreview_Click"/>
        </StackPanel>

        <!-- ============================= -->
        <!-- マスキングプレビュー（表示専用） -->
        <!-- ============================= -->
        <RichTextBox x:Name="PreviewBox"
                     Grid.Row="3"
                     Height="28"
                     IsReadOnly="True"
                     IsDocumentEnabled="True"
                     VerticalScrollBarVisibility="Auto"
                     BorderThickness="1"
                     Padding="4"
                     FontSize="12"/>

        <!-- ============================= -->
        <!-- 入力欄 ＋ Gemini送信（入力右） -->
        <!-- ============================= -->
        <Grid Grid.Row="4" Margin="0,6,0,0">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
            </Grid.ColumnDefinitions>

            <!-- 入力欄 -->
            <TextBox x:Name="InputBox"
                     Grid.Column="0"
                     AcceptsReturn="True"
                     PreviewKeyDown="InputBox_PreviewKeyDown"
                     TextWrapping="Wrap"
                     VerticalScrollBarVisibility="Auto"
                     BorderThickness="1"
                     Padding="8"
                     FontSize="16"
                     TextChanged="InputBox_TextChanged">
                <TextBox.ContextMenu>
                    <ContextMenu>
                        <MenuItem Header="選択文字列をマスキング登録"
                                  Click="MenuRegisterMask_Click"/>
                    </ContextMenu>
                </TextBox.ContextMenu>
            </TextBox>

            <!-- 送信ボタン -->
            <Button x:Name="btnSendGemini"
                    Grid.Column="1"
                    Content="送信"
                    Margin="6,0,0,0"
                    Padding="16,8"
                    FontSize="16"
                    Click="btnSendGemini_Click"/>
        </Grid>

    </Grid>

</UserControl>
